---
title: "data-processing"
author: "Ashley Asmus"
date: "1/12/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(janitor)
library(tidyverse)
library(plotly)
library(councilR)
```

## Read in raw data from Excel
### copy data
```{r load}
raw_load_data <- read_excel("data/raw-load-data.xlsx",
  col_types = c(
    "text", "skip", "skip",
    "date", "skip", "numeric", "numeric",
    "skip", "skip", "skip", "numeric",
    "skip", "skip", "skip", "skip", "skip",
    "skip", "skip", "skip", "skip"
  ),
  skip = 1
) %>%
  janitor::clean_names() %>%
  mutate(sample_start_date = as.Date(sample_start_date))
```

### variant data
```{r variants}
raw_variant_data <- read_excel(
  "data/raw-variant-data.xlsx",
  col_types = c(
    "date",
    "text",
    "numeric",
    "skip",
    "skip",
    "numeric",
    "skip",
    "skip",
    "numeric",
    "skip",
    "skip",
    "numeric",
    "skip",
    "skip",
    "numeric",
    "skip",
    "skip",
    "numeric"
  ),
  skip = 1
) %>%
  janitor::clean_names() %>%
  mutate(date = as.Date(date))
```

### case load from MDH
```{r}
case_data <- read_excel("data/raw-case-data.xlsx",
  sheet = "Metro area new cases"
) %>%
  janitor::clean_names() %>%
  mutate(date_reported = as.Date(date_reported)) %>%
  rename(date = date_reported, covid_cases_7day = x7_day_moving_avg) %>% 
  mutate(hover_text_case = paste0(format(date, "%b %d, %Y"), "<br>",
                             "<b>", round(covid_cases_7day, 2), "</b> cases per 100,000 people") )
```


## Cacluate load  

```{r load reshape}
seq_date <- function(x) seq(min(x, na.rm = T), max(x, na.rm = T), by = "day")
all_dates <- seq_date(raw_load_data$sample_start_date)

load_data <-
  raw_load_data %>%
  mutate(flow_l_day = metro_flow_rate_mgd_on_sample_start_date * 3785411.8) %>%
  select(-metro_flow_rate_mgd_on_sample_start_date) %>%
  rename(N1_gene_l = copies_l_3, N2_gene_l = copies_l_4) %>%
  pivot_longer(
    cols = c("N1_gene_l", "N2_gene_l"), names_to = "gene_num",
    values_to = "n_l"
  ) %>%
  # calculate n per day, per person, per person in millions
  mutate(copies_day = n_l * flow_l_day) %>%
  mutate(copies_day_person = copies_day / 195000) %>%
  mutate(copies_day_person_M = copies_day_person / 1e7) %>%
  # average across runs for a sample average
  group_by(sample_name, sample_start_date, flow_l_day) %>%
  summarize(across(c(copies_day_person_M), ~ mean(., na.rm = T))) %>%
  ungroup() %>%
  # average by date:
  group_by(sample_start_date) %>%
  add_tally(name = "n_samples") %>%
  summarize(
    copies_day_person_M_mn = mean(copies_day_person_M, na.rm = T),
    copies_day_person_M_se = sd(copies_day_person_M, na.rm = T) / (n_samples)
  ) %>%
  ungroup() %>%
  unique() %>%
  rename(date = sample_start_date) %>%
  # calculate a rolling 7 day average
  # (fill in for missing dates)
  complete(date = seq.Date(min(date, na.rm = T), max(date, na.rm = T), by = "days")) %>%
  arrange(date) %>% 
  mutate(hover_text_load = paste0(format(date, "%b %d, %Y"), "<br>",
                             "<b>", round(copies_day_person_M_mn, 2), "</b> copies of RNA per day per person"))

head(load_data)
```


## Graph of load and cases
```{r load graph}
ylim.cases <- c(0, max(case_data$covid_cases_7day, na.rm = T))
ylim.load <- c(0, max(load_data$copies_day_person_M_mn, na.rm = T))

b <- diff(ylim.cases)/diff(ylim.load)
library(ggtext)
# Graph of load
load_plot <-
load_data %>%
  left_join(case_data) %>%
  filter(date >= '2021-06-01') %>%
  ggplot(aes(x = date, y = copies_day_person_M_mn)) +
  geom_ribbon(
    aes(ymin = 0, ymax = covid_cases_7day / b),
    fill = colors$suppGray,
    alpha = 0.3,
    na.rm = T,
    linetype = 'blank'
  ) +
  geom_line(
    aes(y = copies_day_person_M_mn),
    color = colors$councilBlue,
    alpha = 0.8,
    lwd = 1.2,
    na.rm = T
  ) +
  scale_y_continuous(
    "COVID-19 cases per 100,000 residents (7-day avg.)",
    sec.axis = sec_axis(
      ~ . * b,
      name = "Viral load (M copies per person, per day)",
      breaks = seq(from = 0, to = 150, by = 25)
    )
  ) +
  labs(
    title = "<span style='color:#0054A4;'>Viral load in wastewater</span>
    compared to <span style='color:#888888;'>metro-area COVID-19 cases</span>",
    x = 'Date',
    caption = paste0(
      "\nCase data (gray area) are seven-day rolling averages for the 7-county area provided by MDH\nand downloaded from USAFacts. Viral load (blue line) are daily data.\nLast sample date ",
      max(load_data$date, na.rm = T),
      "."
    )
  ) +
  scale_x_date(date_breaks = "month", date_labels = "%b '%y") +
  councilR::council_theme() +
  theme(
    axis.title.y.left = element_text(color = "#888888", vjust = 1),
    axis.title.y.right = element_text(color = colors$councilBlue, vjust = 1),
    axis.text.y.left = element_text(color = "#888888", vjust = 0),
    axis.text.y.right = element_text(color = colors$councilBlue, vjust = 0),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_markdown(lineheight = 1.1, size = 18, hjust = 0.5),
    plot.caption = element_text(size = 10, family = 'Helvetica', face = 'italic')
  )

load_plot
library(cowplot)
library(magick)
logo_file <- "metc-wastewater-covid-monitor/www/main-logo.png"

final_load_plot <-
cowplot::ggdraw() + 
  draw_plot(load_plot) +
  draw_image(logo_file, scale = 0.09, x = -0.4, y = -0.45)
final_load_plot

ggsave("cases_vs_load_raw.png", final_load_plot, height = 4, width = 5, units = "in", dpi = 200)


ggplotly(load_plot)
```


## Reshape variant data
```{r variant proportion}
variant_data <-
  raw_variant_data %>%
  # average by date
  group_by(date) %>%
  summarize(across(contains("frequency"), ~ mean(., na.rm = T))) %>%
  ungroup() %>%
  pivot_longer(contains("frequency"), names_to = "mutation", values_to = "frequency") %>%
  # frequency to 100
  # mutate(frequency = 100 * frequency) %>%
  mutate(mutation = str_remove(mutation, "_frequency")) %>%
  mutate(variant = case_when(
    mutation == "n501y" ~ "Alpha, Beta & Gamma",
    mutation == "l452r" ~ "Delta",
    mutation == "k417n" & date >= "2021-11-18" ~ "Omicron",
    TRUE ~ "Other"
  )) %>%
  mutate(mutation = toupper(mutation)) %>%
  # rolling 7 day average, by variant type
  complete(nesting(mutation, variant),
    date = seq.Date(min(date, na.rm = T), max(date, na.rm = T), by = "days")
  ) %>%
  group_by(mutation, variant) %>%
  # interpolate missing values up to 3 days:
  mutate(frequency_gapfill = zoo::na.approx(frequency, maxgap = 2, na.rm = F)) %>%
  # now getting a rolling average with a 7-day window: 
  mutate(frequency_7day = zoo::rollapply(frequency_gapfill, 7, align = "center", mean, na.rm = T, partial = T, fill = NA)) %>%
  ungroup() %>%
  arrange(date, mutation, variant) %>%
  filter(!variant == "Other") %>% 
  mutate(hover_text_variant = paste0(format(date, "%b %d, %Y"), "<br>",
         "<b>",  variant, "</b> ", round(frequency_7day * 100, digits = 2), "%" ))
# View(variant_data)
```


## Graph of variants
```{r variant graph}
# variant_plot<-
library(showtext)
font_add("HelveticaNeueLTStd", "HelveticaNeueLTStd-Lt.otf")
showtext_auto()



varplot <- 
variant_data %>%
  filter(!variant == "Other") %>%
  filter(date >= '2021-06-01') %>%
  ggplot(aes(x = date, y = frequency, color = variant, fill = variant)) + 
  geom_line(aes(x = date, y = frequency_7day, color = variant), size = 0.8) +
  geom_area(position = "identity", aes(x = date, y = frequency_7day, group = variant, fill = variant, color = variant), alpha = 0.25, na.rm = T, lty = "blank") + 
    geom_point()+
  scale_color_manual(values = c("#84BB25", "#1D94B7", "#6D3571"),
                     name = "Variant: ")+
  scale_fill_manual(values = c("#84BB25", "#1D94B7", "#6D3571"), name = "Variant: ")+
  scale_y_continuous(name = "Variant frequency (%)", labels = scales::percent, limits = c(0, 1.05))+
  scale_x_date(name = "Date", breaks = "1 months", date_labels = "%b '%y")+
  councilR::council_theme() +
  labs(
    title = "COVID-19 Variants in Metro Plant Wastewater",
    caption = paste0("Shaded areas and lines are seven-day rolling averages. Points are daily data.\nLast sample date ",  max(variant_data$date, na.rm = T), "."))+
  # theme_minimal() + 
  theme(panel.grid.minor = element_blank(), 
        panel.grid.major.x = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.position = 'bottom',
        plot.caption = element_text(size = 11, face = 'italic', family = "Helvetica"),
        legend.text = element_text(size = 12))
#         legend.title = element_text(family = "HelveticaNeueLTStd-Lt", size = 12)) 
varplot

library(cowplot)
library(magick)
logo_file <- "metc-wastewater-covid-monitor/www/main-logo.png"

final_varplot <-
cowplot::ggdraw() + 
  draw_plot(varplot) +
  draw_image(logo_file, scale = 0.1, x = -0.4, y = -0.42)

ggsave("variants_static_graph_raw.png", final_varplot, height = 4, width = 5, units = "in", dpi = 200)
```

## Linear regression with cases
```{r}
```


## Write to .csv
```{r}

write.csv(case_data, 'metc-wastewater-covid-monitor/case_data.csv', row.names = F)
write.csv(variant_data, 'data/clean_variant_data.csv', row.names = F)
write.csv(variant_data, 'metc-wastewater-covid-monitor/clean_variant_data.csv', row.names = F)
write.csv(load_data, 'data/clean_load_data.csv', row.names = F)
write.csv(load_data, 'metc-wastewater-covid-monitor/clean_load_data.csv', row.names = F)

# master dataset:
combined_data <-
  case_data %>%
  left_join(load_data, by = "date") %>%
  left_join(variant_data, by = "date")

write.csv(combined_data, "data/combined_data.csv", row.names = F)

write.csv(combined_data, "metc-wastewater-covid-monitor/combined_data.csv", row.names = F)
```
